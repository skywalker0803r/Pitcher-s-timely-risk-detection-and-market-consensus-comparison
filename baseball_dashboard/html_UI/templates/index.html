<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>棒球投手姿勢即時分析儀表板</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: #f8f9fa;
    }
    #video-stream {
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      background: #000;
    }
    .card {
      box-shadow: 0 6px 18px rgba(0,0,0,0.1);
      border-radius: 12px;
    }
    .joint-value {
      font-weight: 600;
      font-size: 1.2rem;
    }
    #loading-spinner {
      display: none;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4 shadow-sm">
  <div class="container">
    <a class="navbar-brand" href="#">⚾ 投手姿勢分析</a>
  </div>
</nav>

<div class="container">

  <!-- 上傳區塊 -->
  <div class="card p-4 mb-4">
    <h4 class="card-title mb-3">上傳影片以開始分析</h4>
    <form id="upload-form" class="d-flex gap-3 align-items-center flex-wrap">
      <input class="form-control form-control-lg" type="file" id="video-upload" accept="video/*" required style="max-width: 300px;" />
      <button type="submit" class="btn btn-primary btn-lg px-4">開始上傳</button>

      <!-- Loading spinner -->
      <div id="loading-spinner" class="spinner-border text-primary" role="status" aria-hidden="true"></div>
      <span id="status-text" class="ms-2"></span>
    </form>
  </div>

  <div class="row g-4">
    <!-- 左側影片區 -->
    <div class="col-md-6">
      <div class="card p-3">
        <h5 class="card-title mb-3">投手影片串流 (含骨架標記)</h5>
        <img id="video-stream" width="100%" height="auto" />
        <div class="mt-4">
          <label for="joint-select" class="form-label fw-semibold">選擇要追蹤的關節</label>
          <select id="joint-select" class="form-select form-select-lg">
            {% for idx, name in joint_names.items() %}
              <option value="{{ idx }}">{{ idx }}: {{ name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <!-- 右側折線圖區 -->
    <div class="col-md-6">
      <div class="card p-4">
        <h5 id="chart-title" class="card-title mb-4">關節位置變化 (x/y/z)</h5>
        
        <!-- 即時座標數值 -->
        <div class="d-flex justify-content-around mb-3">
          <div class="text-danger joint-value" id="val-x">X: --</div>
          <div class="text-success joint-value" id="val-y">Y: --</div>
          <div class="text-primary joint-value" id="val-z">Z: --</div>
        </div>

        <canvas id="joint-chart" height="320"></canvas>
      </div>
    </div>
  </div>

  <!-- 姿勢分析結果區塊 -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card p-4 text-center">
        <h4 class="card-title mb-3">
          <i class="bi bi-graph-up-arrow text-primary me-2"></i>姿勢分析結果
        </h4>
        <div id="pose-status" class="fs-5 fw-semibold text-dark">
          分析尚未開始，請上傳影片以開始分析。
        </div>
      </div>
    </div>
  </div>


<script>
const uploadForm = document.getElementById('upload-form');
const videoUpload = document.getElementById('video-upload');
const videoStream = document.getElementById('video-stream');
const jointSelect = document.getElementById('joint-select');
const statusText = document.getElementById('status-text');
const loadingSpinner = document.getElementById('loading-spinner');

const valX = document.getElementById('val-x');
const valY = document.getElementById('val-y');
const valZ = document.getElementById('val-z');

const ctx = document.getElementById('joint-chart').getContext('2d');

let socket = null;
let chart = null;

const maxDataPoints = 100;
const dataX = [];
const dataY = [];
const dataZ = [];

uploadForm.addEventListener('submit', async e => {
  e.preventDefault();
  if (videoUpload.files.length === 0) {
    alert("請選擇影片檔");
    return;
  }

  loadingSpinner.style.display = 'inline-block';
  statusText.textContent = "影片上傳中...";

  const formData = new FormData();
  formData.append('video', videoUpload.files[0]);

  try {
    const res = await fetch('/upload', {
      method: 'POST',
      body: formData
    });
    const result = await res.json();
    if (result.success) {
      statusText.textContent = "上傳成功，開始分析...";
      videoStream.src = '/video_feed';

      if (socket) {
        socket.disconnect();
      }
      initSocket();
    } else {
      statusText.textContent = "上傳失敗";
      alert("影片上傳失敗");
    }
  } catch(err) {
    statusText.textContent = "錯誤發生";
    alert("影片上傳錯誤：" + err);
  } finally {
    loadingSpinner.style.display = 'none';
  }
});

jointSelect.addEventListener('change', () => {
  if (socket) {
    socket.emit('select_joint', { joint: jointSelect.value });
    resetChartData();
    updateChartTitle();
    resetCoordinateValues();
  }
});

function initSocket() {
  socket = io();

  socket.on('connect', () => {
    console.log('Socket connected');
    socket.emit('select_joint', { joint: jointSelect.value });
    resetChartData();
    updateChartTitle();
    statusText.textContent = "分析中...";
  });

  socket.on('joint_data', data => {
    if (data.x !== null && data.y !== null && data.z !== null) {
      pushData(dataX, data.x);
      pushData(dataY, data.y);
      pushData(dataZ, data.z);
      updateChart();

      valX.textContent = `X: ${data.x.toFixed(3)}`;
      valY.textContent = `Y: ${data.y.toFixed(3)}`;
      valZ.textContent = `Z: ${data.z.toFixed(3)}`;
    } else {
      valX.textContent = `X: --`;
      valY.textContent = `Y: --`;
      valZ.textContent = `Z: --`;
    }
  });

  socket.on('pose_feedback', (data) => {
    if (data.error) {
        document.getElementById('pose-status').innerText = "分析錯誤: " + data.error;
    } else {
        document.getElementById('pose-status').innerText =
            `肘部角度: ${data.elbow_angle.toFixed(2)}° → ${data.status}`;
    }
});

  socket.on('disconnect', () => {
    console.log('Socket disconnected');
    statusText.textContent = "連線中斷";
  });
}

function pushData(arr, val) {
  arr.push(val);
  if (arr.length > maxDataPoints) {
    arr.shift();
  }
}

function resetChartData() {
  dataX.length = 0;
  dataY.length = 0;
  dataZ.length = 0;
}

function resetCoordinateValues() {
  valX.textContent = "X: --";
  valY.textContent = "Y: --";
  valZ.textContent = "Z: --";
}

function updateChartTitle() {
  const idx = jointSelect.value;
  const name = jointSelect.options[jointSelect.selectedIndex].text;
  document.getElementById('chart-title').textContent = `關節 ${idx}: ${name} 位置變化 (x/y/z)`;
}

function updateChart() {
  if (!chart) {
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dataX.map((_, i) => i),
        datasets: [
          {
            label: 'X',
            borderColor: 'red',
            backgroundColor: 'rgba(255,0,0,0.2)',
            data: dataX,
            fill: true,
            tension: 0.2,
            pointRadius: 0,
          },
          {
            label: 'Y',
            borderColor: 'green',
            backgroundColor: 'rgba(0,128,0,0.2)',
            data: dataY,
            fill: true,
            tension: 0.2,
            pointRadius: 0,
          },
          {
            label: 'Z',
            borderColor: 'blue',
            backgroundColor: 'rgba(0,0,255,0.2)',
            data: dataZ,
            fill: true,
            tension: 0.2,
            pointRadius: 0,
          },
        ]
      },
      options: {
        animation: false,
        responsive: true,
        scales: {
          x: { display: false },
          y: { beginAtZero: true }
        },
        plugins: {
          legend: { position: 'top' }
        }
      }
    });
  } else {
    chart.data.labels = dataX.map((_, i) => i);
    chart.data.datasets[0].data = dataX;
    chart.data.datasets[1].data = dataY;
    chart.data.datasets[2].data = dataZ;
    chart.update('none');
  }
}

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
